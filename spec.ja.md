# ぷよぷよゲーム仕様書

## 1. 概要

本文書は、React、TypeScript、およびNode.js（Socket.IOを使用）で開発されたWebアプリケーション「ぷよぷよゲーム」の仕様を概説するものです。このゲームは、一人用（AI対戦）とオンラインマルチプレイヤーモードの両方をサポートしています。

## 2. 基本的なゲームの仕組み

### 2.1. ぷよとフィールド

-   **フィールド:** ゲームは6x12のグリッド上でプレイされます。
-   **ぷよ:** ぷよはフィールドの上から落ちてくる色付きのピースです。色は赤、緑、青、黄、紫の5色です。
-   **プレイヤー操作:** プレイヤーは2つ1組のぷよを操作し、左右への移動、回転、高速落下させることができます。

### 2.2. ぷよの消去

-   **接続:** 同じ色のぷよが4つ以上、水平または垂直に繋がると消えます。
-   **連鎖:** ぷよが消えると、その上にあったぷよが落下します。これにより、再び4つ以上のぷよが繋がると連鎖反応が起こります。
-   **スコア:** スコアは、消したぷよの数と連鎖の長さに基づいて計算されます。

### 2.3. ゲームオーバー

-   フィールドの左から3列目、最上段にぷよが置かれるとゲームオーバーです。

## 3. ゲームモード

### 3.1. AI対戦モード

-   プレイヤーはAI（人工知能）の対戦相手とプレイできます。
-   AIロジックは、連鎖を作りプレイヤーを攻撃するための最適な手を見つけ出すように設計されています。

### 3.2. オンラインマルチプレイヤーモード

-   プレイヤーはルームIDを使用してルームに参加し、オンラインで他のプレイヤーと対戦できます。
-   ゲームの状態は、Socket.IOを使用してプレイヤー間で同期されます。

## 4. 発展的なルール

### 4.1. おじゃまぷよ

-   **送信:** 連鎖をすると、相手のフィールドにおじゃまぷよを送ります。送られるおじゃまぷよの数は、連鎖の威力に基づいて計算されます。
-   **受信:** おじゃまぷよはフィールドの上から降り注ぎ、隣接する色ぷよを消すことによってのみ消すことができます。
-   **相殺:** 相手からおじゃまぷよが送られてくる予告があるときに、こちらも連鎖をすることで、送られてくるおじゃまぷよの数を減らすことができます。もし自分の連鎖の威力が相手を上回れば、残ったおじゃまぷよを相手に送り返すことができます。

### 4.2. 全消しボーナス

-   フィールド上のすべてのぷよを消すと、大幅なボーナスが得られ、相手に大量のおじゃまぷよを送りつけます。

## 5. AI対戦相手の仕様

AI対戦相手は、可能な限り最善の手を決定するために、高度なロジックに従います。

### 5.1. 意思決定プロセス

1.  **シミュレーション:** AIは、現在のぷよのペアに対するすべての可能な手をシミュレートします。これには、すべての可能な水平位置と4つの回転状態が含まれます。
2.  **評価:** シミュレートされた各手について、AIは包括的な評価関数に基づいて結果のフィールド状態を評価します。
3.  **実行:** AIは、最も評価スコアの高い手を選択し、実行します。

### 5.2. 評価関数

AIの評価関数は、手の良し悪しを判断するために、以下の要素を考慮します。

-   **連鎖の可能性（最優先）:** AIは、可能な限り最長の連鎖を作る手を優先します。連鎖のスコアは、連鎖の長さとともに指数関数的に増加します。
-   **消去されるぷよの数:** 一度に多くのぷよを消すことにも報酬が与えられます。
-   **フィールドの高さ:** フィールドの高い位置にぷよを置くことは、ゲームオーバーのリスクを高めるため、ペナルティが課せられます。
-   **色のグループ化:** 同じ色のぷよを隣接して配置することは、将来の連鎖の可能性を高めるため、報酬が与えられます。

### 5.3. AIの行動サイクル

1.  AIのターンが始まります。
2.  プレイヤーがターンの開始を視覚的に認識できるよう、短い時間（500ミリ秒）待ちます。
3.  `findBestAIMove`関数を使用して最善の手を計算します。
4.  計算された最適な位置に即座にぷよを移動させます。
5.  ぷよをフィールドの最下部まで落下させます。
6.  `fixPuyo`関数が呼び出され、連鎖反応やおじゃまぷよの計算を処理します。
7.  AIのターンが終了し、次のターンを待ちます。

## 6. 技術スタック

-   **フロントエンド:** React, TypeScript
-   **バックエンド:** Node.js, Express, Socket.IO
-   **テスト:** E2EテストにPlaywrightを使用
